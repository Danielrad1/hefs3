import React, { useState, useEffect, useMemo } from 'react';
import { View, Text, Modal, StyleSheet, Pressable, ScrollView, TextInput, Dimensions } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import EmojiPicker from 'rn-emoji-keyboard';
import TriangleColorPicker from 'react-native-wheel-color-picker';
import { useTheme } from '../../../design/theme';
import { s } from '../../../design/spacing';
import { r } from '../../../design/radii';
import { DeckMetadata } from '../../../services/anki/DeckMetadataService';

const { width } = Dimensions.get('window');

interface DeckCustomizationModalProps {
  visible: boolean;
  deckName: string;
  currentMetadata: DeckMetadata | null;
  onSave: (metadata: Partial<Omit<DeckMetadata, 'deckId'>>) => void;
  onClose: () => void;
}

// Icon categories - 200+ icons total
const ICON_CATEGORIES = {
  Education: [
    'book', 'book-outline', 'library', 'library-outline', 'school', 'school-outline',
    'calculator', 'calculator-outline', 'pencil', 'pencil-outline', 'create', 'create-outline',
    'document-text', 'document-text-outline', 'document', 'document-outline',
    'newspaper', 'newspaper-outline', 'reader', 'reader-outline', 'documents', 'documents-outline',
    'clipboard', 'clipboard-outline', 'journal', 'journals', 'bookmark', 'bookmark-outline',
    'bookmarks', 'bookmarks-outline', 'albums', 'albums-outline'
  ],
  Science: [
    'flask', 'flask-outline', 'beaker', 'beaker-outline', 'medical', 'medical-outline',
    'fitness', 'fitness-outline', 'pulse', 'pulse-outline', 'heart', 'heart-outline',
    'water', 'water-outline', 'leaf', 'leaf-outline', 'nutrition', 'nutrition-outline',
    'eyedrop', 'eyedrop-outline', 'magnet', 'magnet-outline', 'thermometer', 'thermometer-outline',
    'telescope', 'battery-full', 'battery-half', 'bandage', 'bandage-outline'
  ],
  Languages: [
    'language', 'globe', 'globe-outline', 'earth', 'earth-outline',
    'map', 'map-outline', 'flag', 'flag-outline', 'location', 'location-outline',
    'navigate', 'navigate-outline', 'compass', 'compass-outline', 'pin', 'pin-outline',
    'chatbubble', 'chatbubble-outline', 'chatbubbles', 'chatbubbles-outline',
    'text', 'text-outline', 'megaphone', 'megaphone-outline'
  ],
  Tech: [
    'code-slash', 'code-slash-outline', 'terminal', 'terminal-outline', 'bug', 'bug-outline',
    'hardware-chip', 'hardware-chip-outline', 'server', 'server-outline',
    'laptop', 'laptop-outline', 'desktop', 'desktop-outline',
    'phone-portrait', 'phone-portrait-outline', 'tablet-portrait', 'tablet-portrait-outline',
    'watch', 'watch-outline', 'wifi', 'wifi-outline', 'bluetooth', 'bluetooth-outline',
    'cloud', 'cloud-outline', 'cloud-upload', 'cloud-download', 'download', 'download-outline'
  ],
  Business: [
    'business', 'business-outline', 'briefcase', 'briefcase-outline',
    'cash', 'cash-outline', 'card', 'card-outline', 'wallet', 'wallet-outline',
    'trending-up', 'trending-up-outline', 'trending-down', 'trending-down-outline',
    'stats-chart', 'stats-chart-outline', 'pie-chart', 'pie-chart-outline',
    'analytics', 'analytics-outline', 'bar-chart', 'bar-chart-outline',
    'calculator', 'receipt', 'receipt-outline', 'pricetag', 'pricetag-outline'
  ],
  Music: [
    'musical-notes', 'musical-notes-outline', 'musical-note', 'musical-note-outline',
    'headset', 'headset-outline', 'mic', 'mic-outline', 'mic-off', 'mic-off-outline',
    'camera', 'camera-outline', 'videocam', 'videocam-outline',
    'brush', 'brush-outline', 'color-palette', 'color-palette-outline',
    'easel', 'easel-outline', 'film', 'film-outline', 'images', 'images-outline',
    'image', 'image-outline', 'play', 'play-outline', 'pause', 'pause-outline'
  ],
  Sports: [
    'barbell', 'barbell-outline', 'dumbbell', 'fitness', 'fitness-outline',
    'basketball', 'basketball-outline', 'football', 'football-outline',
    'tennis-ball', 'tennis-ball-outline', 'baseball', 'baseball-outline',
    'bicycle', 'bicycle-outline', 'walk', 'walk-outline', 'body', 'body-outline',
    'trophy', 'trophy-outline', 'medal', 'medal-outline', 'ribbon', 'ribbon-outline',
    'disc', 'american-football', 'golf', 'golf-outline'
  ],
  Transport: [
    'car', 'car-outline', 'car-sport', 'car-sport-outline', 'bus', 'bus-outline',
    'train', 'train-outline', 'subway', 'airplane', 'airplane-outline',
    'boat', 'boat-outline', 'bicycle', 'bicycle-outline',
    'rocket', 'rocket-outline', 'navigate', 'navigate-outline',
    'speedometer', 'speedometer-outline', 'map', 'map-outline'
  ],
  Home: [
    'home', 'home-outline', 'bed', 'bed-outline', 'bulb', 'bulb-outline',
    'gift', 'gift-outline', 'key', 'key-outline', 'lock-closed', 'lock-closed-outline',
    'restaurant', 'restaurant-outline', 'cafe', 'cafe-outline', 'pizza', 'pizza-outline',
    'fast-food', 'fast-food-outline', 'beer', 'beer-outline', 'wine', 'wine-outline',
    'ice-cream', 'ice-cream-outline', 'egg', 'egg-outline'
  ],
  Nature: [
    'sunny', 'sunny-outline', 'moon', 'moon-outline', 'cloudy', 'cloudy-outline',
    'rainy', 'rainy-outline', 'snow', 'snow-outline', 'thunderstorm', 'thunderstorm-outline',
    'flower', 'flower-outline', 'rose', 'rose-outline', 'leaf', 'leaf-outline',
    'water', 'water-outline', 'flame', 'flame-outline', 'flash', 'flash-outline',
    'umbrella', 'umbrella-outline', 'planet', 'planet-outline'
  ],
  Fun: [
    'game-controller', 'game-controller-outline', 'dice', 'dice-outline',
    'trophy', 'trophy-outline', 'medal', 'medal-outline', 'ribbon', 'ribbon-outline',
    'star', 'star-outline', 'star-half', 'star-half-outline',
    'flame', 'flame-outline', 'diamond', 'diamond-outline',
    'shield', 'shield-outline', 'skull', 'skull-outline',
    'happy', 'happy-outline', 'heart', 'heart-outline', 'sparkles', 'sparkles-outline'
  ],
};

const COLORS = [
  // Reds
  '#EF4444', '#DC2626', '#B91C1C', '#F87171',
  // Oranges
  '#F97316', '#EA580C', '#C2410C', '#FB923C',
  // Yellows
  '#EAB308', '#CA8A04', '#A16207', '#FACC15',
  // Greens
  '#22C55E', '#16A34A', '#15803D', '#4ADE80',
  // Teals
  '#14B8A6', '#0D9488', '#0F766E', '#2DD4BF',
  // Blues
  '#3B82F6', '#2563EB', '#1D4ED8', '#60A5FA',
  // Purples
  '#8B5CF6', '#7C3AED', '#6D28D9', '#A78BFA',
  // Pinks
  '#EC4899', '#DB2777', '#BE185D', '#F472B6',
  // Neutrals
  '#64748B', '#475569', '#334155', '#94A3B8',
];

export default function DeckCustomizationModalV2({
  visible,
  deckName,
  currentMetadata,
  onSave,
  onClose,
}: DeckCustomizationModalProps) {
  const theme = useTheme();
  const [selectedIcon, setSelectedIcon] = useState<string | undefined>(currentMetadata?.icon);
  const [selectedColor, setSelectedColor] = useState<string | undefined>(currentMetadata?.color);
  const [isEmojiPickerOpen, setIsEmojiPickerOpen] = useState(false);
  const [isColorPickerOpen, setIsColorPickerOpen] = useState(false);
  const [isIconPickerOpen, setIsIconPickerOpen] = useState(false);
  const [iconSearchQuery, setIconSearchQuery] = useState('');

  useEffect(() => {
    if (visible) {
      setSelectedIcon(currentMetadata?.icon);
      setSelectedColor(currentMetadata?.color);
    }
  }, [visible, currentMetadata]);

  // Flatten all icons for picker
  const allIcons = useMemo(() => {
    return Object.values(ICON_CATEGORIES).flat();
  }, []);

  const filteredIcons = useMemo(() => {
    if (!iconSearchQuery) return allIcons;
    return allIcons.filter(icon => icon.toLowerCase().includes(iconSearchQuery.toLowerCase()));
  }, [allIcons, iconSearchQuery]);

  const handleSave = () => {
    onSave({
      icon: selectedIcon,
      color: selectedColor,
    });
    onClose();
  };

  const handleClear = () => {
    onSave({ icon: undefined, color: undefined });
    onClose();
  };

  const isEmoji = selectedIcon && selectedIcon.length <= 2 && !/^[a-z-]+$/.test(selectedIcon);

  return (
    <Modal visible={visible} transparent animationType="slide" onRequestClose={onClose}>
      <View style={[styles.overlay, { backgroundColor: 'rgba(0,0,0,0.75)' }]}>
        <View style={[styles.modal, { backgroundColor: theme.colors.surface }]}>
          {/* Sticky Header with Preview */}
          <View style={[styles.header, { borderBottomColor: theme.colors.border }]}>
            <View style={styles.headerTop}>
              <Text style={[styles.title, { color: theme.colors.textPrimary }]}>
                Customize
              </Text>
              <Pressable onPress={onClose} style={styles.closeButton}>
                <Ionicons name="close" size={28} color={theme.colors.textSecondary} />
              </Pressable>
            </View>
            
            {/* Live Preview */}
            <View style={[
              styles.previewCard,
              {
                backgroundColor: selectedColor ? selectedColor + '15' : theme.colors.bg,
                borderColor: selectedColor || theme.colors.border,
              }
            ]}>
              {selectedIcon && (
                isEmoji ? (
                  <Text style={styles.previewEmoji}>{selectedIcon}</Text>
                ) : (
                  <Ionicons name={selectedIcon as any} size={32} color={selectedColor || theme.colors.accent} />
                )
              )}
              <View style={{ flex: 1 }}>
                <Text style={[styles.previewName, { color: theme.colors.textPrimary }]} numberOfLines={1}>
                  {deckName}
                </Text>
                <Text style={[styles.previewHint, { color: theme.colors.textSecondary }]}>
                  {selectedIcon || selectedColor ? 'Preview' : 'Select icon & color below'}
                </Text>
              </View>
            </View>
          </View>

          {/* Scrollable Content - Clean Picker Cards */}
          <ScrollView style={styles.content} showsVerticalScrollIndicator={false}>
            {/* Icon Picker Card */}
            <Pressable
              style={[
                styles.pickerCard,
                {
                  backgroundColor: theme.colors.bg,
                  borderColor: theme.colors.border,
                }
              ]}
              onPress={() => setIsIconPickerOpen(true)}
            >
              <View style={styles.pickerLeft}>
                <Ionicons name="apps" size={24} color={theme.colors.accent} />
                <Text style={[styles.pickerLabel, { color: theme.colors.textPrimary }]}>
                  Icon
                </Text>
              </View>
              {selectedIcon && !isEmoji ? (
                <Ionicons name={selectedIcon as any} size={28} color={theme.colors.accent} />
              ) : (
                <Ionicons name="chevron-forward" size={20} color={theme.colors.textSecondary} />
              )}
            </Pressable>

            {/* Emoji Picker Card */}
            <Pressable
              style={[
                styles.pickerCard,
                {
                  backgroundColor: theme.colors.bg,
                  borderColor: theme.colors.border,
                }
              ]}
              onPress={() => setIsEmojiPickerOpen(true)}
            >
              <View style={styles.pickerLeft}>
                <Ionicons name="happy" size={24} color={theme.colors.accent} />
                <Text style={[styles.pickerLabel, { color: theme.colors.textPrimary }]}>
                  Emoji
                </Text>
              </View>
              {selectedIcon && isEmoji ? (
                <Text style={styles.pickerEmoji}>{selectedIcon}</Text>
              ) : (
                <Ionicons name="chevron-forward" size={20} color={theme.colors.textSecondary} />
              )}
            </Pressable>

            {/* Color Picker Card */}
            <Pressable
              style={[
                styles.pickerCard,
                {
                  backgroundColor: theme.colors.bg,
                  borderColor: theme.colors.border,
                }
              ]}
              onPress={() => setIsColorPickerOpen(true)}
            >
              <View style={styles.pickerLeft}>
                <Ionicons name="color-palette" size={24} color={theme.colors.accent} />
                <Text style={[styles.pickerLabel, { color: theme.colors.textPrimary }]}>
                  Color
                </Text>
              </View>
              {selectedColor ? (
                <View style={styles.pickerColorPreview}>
                  <View style={[styles.pickerColorCircle, { backgroundColor: selectedColor }]} />
                  <Text style={[styles.pickerColorText, { color: theme.colors.textSecondary }]}>
                    {selectedColor.toUpperCase()}
                  </Text>
                </View>
              ) : (
                <Ionicons name="chevron-forward" size={20} color={theme.colors.textSecondary} />
              )}
            </Pressable>

            <View style={{ height: 120 }} />
          </ScrollView>

          {/* Sticky Footer */}
          <View style={[styles.footer, { borderTopColor: theme.colors.border }]}>
            <Pressable
              style={[styles.button, { backgroundColor: theme.colors.bg }]}
              onPress={handleClear}
            >
              <Text style={[styles.buttonText, { color: theme.colors.textSecondary }]}>
                Clear All
              </Text>
            </Pressable>
            <Pressable
              style={[styles.button, { backgroundColor: theme.colors.accent }]}
              onPress={handleSave}
            >
              <Text style={[styles.buttonText, { color: '#FFF' }]}>
                Save
              </Text>
            </Pressable>
          </View>
        </View>
      </View>

      {/* Emoji Picker */}
      <EmojiPicker
        onEmojiSelected={(emoji) => {
          setEmojiInput(emoji.emoji);
          setIsEmojiPickerOpen(false);
        }}
        open={isEmojiPickerOpen}
        onClose={() => setIsEmojiPickerOpen(false)}
        theme={{
          backdrop: theme.colors.bg + 'CC',
          knob: theme.colors.textSecondary,
          container: theme.colors.surface,
          header: theme.colors.textPrimary,
          skinTonesContainer: theme.colors.bg,
          category: {
            icon: theme.colors.textSecondary,
            iconActive: theme.colors.accent,
            container: theme.colors.bg,
            containerActive: theme.colors.accent + '20',
          },
        }}
      />

      {/* Color Picker Modal */}
      <Modal
        visible={isColorPickerOpen}
        transparent
        animationType="slide"
        onRequestClose={() => setIsColorPickerOpen(false)}
      >
        <View style={[styles.colorPickerOverlay, { backgroundColor: theme.colors.bg + 'EE' }]}>
          <View style={[styles.colorPickerModal, { backgroundColor: theme.colors.surface }]}>
            <Text style={[styles.colorPickerTitle, { color: theme.colors.textPrimary }]}>
              Pick a Color
            </Text>
            <View style={{ width: 250, height: 250 }}>
              <TriangleColorPicker
                color={selectedColor || '#3B82F6'}
                onColorChange={(color: string) => setSelectedColor(color)}
              />
            </View>
            <View style={styles.colorPickerButtons}>
              <Pressable
                style={[styles.colorPickerButton, { backgroundColor: theme.colors.bg }]}
                onPress={() => setIsColorPickerOpen(false)}
              >
                <Text style={[styles.colorPickerButtonText, { color: theme.colors.textSecondary }]}>
                  Cancel
                </Text>
              </Pressable>
              <Pressable
                style={[styles.colorPickerButton, { backgroundColor: theme.colors.accent }]}
                onPress={() => setIsColorPickerOpen(false)}
              >
                <Text style={[styles.colorPickerButtonText, { color: '#FFF' }]}>
                  Done
                </Text>
              </Pressable>
            </View>
          </View>
        </View>
      </Modal>
    </Modal>
  );
}

const styles = StyleSheet.create({
  overlay: {
    flex: 1,
    justifyContent: 'flex-end',
  },
  modal: {
    borderTopLeftRadius: r.xl,
    borderTopRightRadius: r.xl,
    maxHeight: '92%',
    height: '92%',
  },
  header: {
    paddingHorizontal: s.lg,
    paddingTop: s.lg,
    paddingBottom: s.md,
    borderBottomWidth: 1,
  },
  headerTop: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: s.md,
  },
  title: {
    fontSize: 24,
    fontWeight: '700',
  },
  closeButton: {
    padding: s.xs,
  },
  previewCard: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: s.md,
    borderRadius: r.lg,
    borderWidth: 2,
    gap: s.md,
  },
  iconContainer: {
    width: 48,
    height: 48,
    borderRadius: r.md,
    alignItems: 'center',
    justifyContent: 'center',
  },
  previewEmoji: {
    fontSize: 28,
  },
  previewName: {
    fontSize: 16,
    fontWeight: '600',
  },
  previewHint: {
    fontSize: 12,
    marginTop: 2,
  },
  content: {
    flex: 1,
    paddingHorizontal: s.lg,
  },
  section: {
    marginTop: s.lg,
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: s.sm,
  },
  segmentControl: {
    flexDirection: 'row',
    backgroundColor: 'rgba(0,0,0,0.05)',
    borderRadius: r.md,
    padding: 2,
  },
  segment: {
    flex: 1,
    paddingVertical: s.sm,
    borderRadius: r.sm,
    alignItems: 'center',
  },
  segmentText: {
    fontSize: 14,
    fontWeight: '600',
  },
  emojiPickerButton: {
    padding: s.xl,
    borderRadius: r.md,
    borderWidth: 1,
    minHeight: 120,
    alignItems: 'center',
    justifyContent: 'center',
  },
  selectedEmoji: {
    fontSize: 48,
  },
  emojiPlaceholder: {
    alignItems: 'center',
    gap: s.sm,
  },
  emojiPlaceholderText: {
    fontSize: 14,
  },
  searchInput: {
    fontSize: 15,
    padding: s.md,
    borderRadius: r.md,
    borderWidth: 1,
  },
  categoryScroll: {
    marginTop: s.md,
  },
  categoryContent: {
    gap: s.sm,
    paddingRight: s.lg,
  },
  categoryTab: {
    paddingHorizontal: s.md,
    paddingVertical: s.sm,
    borderRadius: r.full,
    borderWidth: 1,
  },
  categoryText: {
    fontSize: 13,
    fontWeight: '600',
  },
  iconGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: s.sm,
    marginTop: s.md,
  },
  iconButton: {
    width: (width - s.lg * 2 - s.sm * 5) / 6,
    aspectRatio: 1,
    alignItems: 'center',
    justifyContent: 'center',
    borderRadius: r.md,
    borderWidth: 1.5,
  },
  colorRow: {
    flexDirection: 'row',
    gap: s.sm,
    flexWrap: 'wrap',
  },
  colorButton: {
    width: 44,
    height: 44,
    borderRadius: 22,
    alignItems: 'center',
    justifyContent: 'center',
  },
  colorSelected: {
    borderWidth: 3,
    borderColor: '#FFF',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.3,
    shadowRadius: 4,
    elevation: 5,
  },
  customColor: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: s.md,
    gap: s.sm,
  },
  hexInput: {
    flex: 1,
    fontSize: 14,
    padding: s.sm,
    paddingHorizontal: s.md,
    borderRadius: r.md,
    borderWidth: 1,
    fontFamily: 'monospace',
  },
  colorPreview: {
    width: 36,
    height: 36,
    borderRadius: r.sm,
    borderWidth: 2,
    borderColor: '#FFF',
  },
  footer: {
    flexDirection: 'row',
    padding: s.lg,
    gap: s.md,
    borderTopWidth: 1,
  },
  button: {
    flex: 1,
    paddingVertical: s.md,
    borderRadius: r.md,
    alignItems: 'center',
  },
  buttonText: {
    fontSize: 16,
    fontWeight: '600',
  },
  colorPickerButton: {
    padding: s.xl,
    borderRadius: r.md,
    borderWidth: 1,
    minHeight: 100,
    alignItems: 'center',
    justifyContent: 'center',
  },
  colorPreviewRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: s.md,
  },
  colorPreviewCircle: {
    width: 48,
    height: 48,
    borderRadius: 24,
    borderWidth: 2,
    borderColor: '#FFF',
  },
  colorPreviewText: {
    fontSize: 16,
    fontWeight: '600',
    fontFamily: 'monospace',
  },
  colorPlaceholder: {
    alignItems: 'center',
    gap: s.sm,
  },
  colorPlaceholderText: {
    fontSize: 14,
  },
  colorPickerOverlay: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: s.xl,
  },
  colorPickerModal: {
    width: '100%',
    maxWidth: 400,
    borderRadius: r.lg,
    padding: s.xl,
    gap: s.lg,
  },
  colorPickerTitle: {
    fontSize: 20,
    fontWeight: '700',
    textAlign: 'center',
  },
  colorPickerClose: {
    padding: s.md,
    borderRadius: r.md,
    alignItems: 'center',
  },
  colorPickerCloseText: {
    fontSize: 16,
    fontWeight: '600',
  },
  colorPickerButtons: {
    flexDirection: 'row',
    gap: s.md,
    marginTop: s.lg,
  },
  colorPickerButtonText: {
    fontSize: 16,
    fontWeight: '600',
  },
});
